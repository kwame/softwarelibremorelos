name: Deploy Hugo Blog to Remote Server

on:
  push:
    branches:
      - main

env:
  TZ: America/Mexico_City

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Show runner time
        run: |
          echo "Local time:" && date
          echo "UTC time:" && date -u

      - name: List content files
        run: |
          ls -R content

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Hugo diagnostics
        run: |
          hugo version
          echo "---- drafts ----"
          hugo list drafts || true
          echo "---- future ----"
          hugo list future || true
          echo "---- expired ----"
          hugo list expired || true
          echo "---- all ----"
          hugo list all | sort || true
          echo "---- verbose build dry-run ----"
          hugo --printI18nWarnings --printPathWarnings --log --verbose --gc --minify -s . -d public >/dev/null 2>&1 || true

      - name: Build site
        run: hugo --gc --minify

      - name: Inspect built site
        run: |
          test -d public && find public -maxdepth 2 -type f | sort | head -n 200
          echo "Total files:" $(find public -type f | wc -l)

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add known hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts

      - name: Deploy to remote server via rsync
        run: |
          rsync -avz --delete \
            public/* \
            infor011@shell.guardedhost.com:/webroot/i/n/infor011/softwarelibremorelos.org/www
